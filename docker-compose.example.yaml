# ================================================
# üß† Canvas LMS + Airflow Analytics (Persistent)
# ================================================
# File: docker-compose.yml
# By: V√µ Tr·ªçng Nghƒ©a
# This setup ensures your Canvas LMS + Airflow keeps all data safe,
# even after "docker compose down".
# ================================================

services:
  # ===========================
  # üéì Canvas LMS Web + Jobs
  # ===========================
  web: &WEB
    build:
      context: .
    links:
      - postgres
      - redis
    environment:
      POSTGRES_PASSWORD: sekret
      LA_DASHBOARD_URL: "http://localhost:5173"
    ports:
      - "3000:80" # Canvas LMS Web UI
    depends_on:
      - postgres
      - redis

  jobs:
    <<: *WEB
    command: bundle exec script/delayed_job run
    depends_on:
      - postgres
      - redis
    ports:
      - "3001:3000"

  # ===========================
  # üóÑÔ∏è PostgreSQL Database
  # ===========================
  postgres:
    build: ./docker-compose/postgres
    environment:
      POSTGRES_PASSWORD: sekret
    ports:
      - "5432:5432" # M·ªü c·ªïng cho Airflow, DBeaver, v.v.
    volumes:
      - canvas_postgres_data:/var/lib/postgresql/data # üü¢ Volume l∆∞u tr·ªØ d·ªØ li·ªáu Canvas LMS
    restart: always

  # ===========================
  # ‚ö° Redis Cache
  # ===========================
  redis:
    image: redis:alpine
    restart: always

  # ========================================
  # üöÄ Airflow for Learning Analytics (ETL)
  # ========================================
  airflow-init:
    build:
      context: ./learning_analytics
    container_name: airflow-init
    depends_on:
      - postgres
    environment:
      - AIRFLOW__CORE__EXECUTOR=LocalExecutor
      - AIRFLOW__CORE__DAGS_ARE_PAUSED_AT_CREATION=False
      - AIRFLOW__CORE__LOAD_EXAMPLES=False
      - AIRFLOW__CORE__DAGS_FOLDER=/opt/airflow/dags
      - AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=postgresql+psycopg2://airflow:airflow@airflow-postgres:5432/airflow
      - _AIRFLOW_DB_MIGRATE=true
      - _AIRFLOW_WWW_USER_CREATE=true
      - _AIRFLOW_WWW_USER_USERNAME=admin
      - _AIRFLOW_WWW_USER_PASSWORD=admin
    volumes:
      - ./learning_analytics/dags:/opt/airflow/dags
      - ./learning_analytics/logs:/opt/airflow/logs
      - ./learning_analytics/plugins:/opt/airflow/plugins
      - ./learning_analytics/.env.local:/opt/airflow/.env.local
    command: >
      bash -c "
        airflow db init &&
        airflow users create --username admin --password admin --firstname Admin --lastname User --role Admin --email admin@example.com || true
      "

  airflow-webserver:
    build:
      context: ./learning_analytics
    container_name: airflow-webserver
    restart: always
    depends_on:
      airflow-init:
        condition: service_completed_successfully
      airflow-postgres:
        condition: service_started
    environment:
      - AIRFLOW__CORE__EXECUTOR=LocalExecutor
      - AIRFLOW__CORE__DAGS_ARE_PAUSED_AT_CREATION=False
      - AIRFLOW__CORE__LOAD_EXAMPLES=False
      - AIRFLOW__CORE__DAGS_FOLDER=/opt/airflow/dags
      - AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=postgresql+psycopg2://airflow:airflow@airflow-postgres:5432/airflow
    ports:
      - "8080:8080" # Airflow UI
    volumes:
      - ./learning_analytics/dags:/opt/airflow/dags
      - ./learning_analytics/logs:/opt/airflow/logs
      - ./learning_analytics/plugins:/opt/airflow/plugins
      - ./learning_analytics/.env.local:/opt/airflow/.env.local
    command: webserver

  airflow-scheduler:
    build:
      context: ./learning_analytics
    container_name: airflow-scheduler
    restart: always
    depends_on:
      airflow-init:
        condition: service_completed_successfully
      airflow-postgres:
        condition: service_started
    environment:
      - AIRFLOW__CORE__EXECUTOR=LocalExecutor
      - AIRFLOW__CORE__DAGS_ARE_PAUSED_AT_CREATION=False
      - AIRFLOW__CORE__LOAD_EXAMPLES=False
      - AIRFLOW__CORE__DAGS_FOLDER=/opt/airflow/dags
      - AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=postgresql+psycopg2://airflow:airflow@airflow-postgres:5432/airflow
    volumes:
      - ./learning_analytics/dags:/opt/airflow/dags
      - ./learning_analytics/logs:/opt/airflow/logs
      - ./learning_analytics/plugins:/opt/airflow/plugins
      - ./learning_analytics/.env.local:/opt/airflow/.env.local
    command: scheduler

  # ===========================
  # üóÑÔ∏è Airflow Database
  # ===========================
  airflow-postgres:
    image: postgres:14
    container_name: airflow-postgres
    environment:
      POSTGRES_USER: airflow
      POSTGRES_PASSWORD: airflow
      POSTGRES_DB: airflow
    volumes:
      - airflow_postgres_data:/var/lib/postgresql/data # üü¢ L∆∞u d·ªØ li·ªáu Airflow metadata
    restart: always

  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: canvas-pgadmin
    restart: always
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@pgadmin.com
      PGADMIN_DEFAULT_PASSWORD: admin123
    ports:
      - "5050:80" # M·ªü c·ªïng truy c·∫≠p PgAdmin UI
    depends_on:
      - postgres
    volumes:
      - pgadmin_data:/var/lib/pgadmin

  # ===========================
  # Learning Analytics Dashboard (Backend API)
  # ===========================
  dashboard-backend:
    image: node:20
    working_dir: /app
    volumes:
      - ./learning_analytics/dashboard_backend:/app
    environment:
      - PORT=4000
      - DATABASE_URL=postgresql://postgres:sekret@postgres:5432/canvas_dwh
      - CORS_ORIGIN=http://localhost:5173
      - NODE_ENV=development
    command: sh -lc "npm ci && npm run dev"
    depends_on:
      - postgres
    ports:
      - "4000:4000"

  # ===========================
  # Learning Analytics Dashboard (Frontend Vite)
  # ===========================
  dashboard-frontend:
    image: node:20
    working_dir: /app
    volumes:
      - ./learning_analytics/dashboard_frontend:/app
    environment:
      - PORT=5173
      - VITE_API_PROXY=http://dashboard-backend:4000
      - NODE_ENV=development
    command: sh -lc "npm ci && npm run dev -- --host 0.0.0.0"
    depends_on:
      - dashboard-backend
    ports:
      - "5173:5173"

# ===========================
# üíæ Persistent Volumes
# ===========================
volumes:
  canvas_postgres_data:
  airflow_postgres_data:
  pgadmin_data:
